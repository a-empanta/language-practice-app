events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Send files efficiently
    sendfile        on;
    # Keep idle connections open this long
    keepalive_timeout 65;

    server {
        # Listen for IPv4 & IPv6 on port 80 and make this the default vhost
        listen 80 default_server;
        listen [::]:80 default_server;

        # The domain you own & are validating
        server_name langpractise.zapto.org;

        # ----------------------------------------------------------------
        # Serve Let's Encrypt challenge files from /var/www/certbot
        # ----------------------------------------------------------------
        location /.well-known/acme-challenge/ {
            # alias makes the URL path map directly to the filesystem
            alias /var/www/certbot/.well-known/acme-challenge/;
            # (ensure Certbot writes challenge files into that directory)
        }

        # ----------------------------------------------------------------
        # Redirect all other HTTP traffic to HTTPS
        # ----------------------------------------------------------------
        location / {
            # 301 = permanent redirect
            return 301 https://$host$request_uri;
        }
    }

    # --------------------------------
    # 2) HTTPS server: Laravel + PHP
    # --------------------------------
    server {
        # Listen on 443 with SSL and HTTP/2 enabled
        listen 443 ssl http2 default_server;
        listen [::]:443 ssl http2 default_server;

        server_name langpractise.zapto.org;

        # ----------------------------------------------------------------
        # TLS certificate and key (from Certbot)
        # ----------------------------------------------------------------
        ssl_certificate      /etc/nginx/ssl/live/langpractise.zapto.org/fullchain.pem;
        ssl_certificate_key  /etc/nginx/ssl/live/langpractise.zapto.org/privkey.pem;

        # Strong SSL protocols & ciphers
        ssl_protocols        TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers          HIGH:!aNULL:!MD5;

        # ----------------------------------------------------------------
        # Serve the Laravel appâ€™s public directory
        # ----------------------------------------------------------------
        root   /var/www/public;
        index  index.php index.html;

        # Static files & SPA front controller
        location / {
            # Try to serve file directly, fallback to index.php
            try_files $uri $uri/ /index.php?$query_string;
        }

        # PHP-FPM handling
        location ~ \.php$ {
            # Pass PHP requests to the php-fpm container
            fastcgi_pass   php-fpm:9000;
            fastcgi_index  index.php;

            # Tell PHP where the script lives
            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;

            # Load the default FastCGI parameters
            include        fastcgi_params;
        }

        # (Optional) Deny access to .env and other hidden files
        location ~ /\.(env|git) {
            deny all;
        }
    }
}
